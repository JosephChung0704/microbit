<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>micro:bit BLE Test</title>
</head>
<body>
  <h2>micro:bit Bluetooth 연결 테스트</h2>

  <button onclick="connectMicrobit()">🔗 micro:bit 연결</button>
  <button onclick="sendMessage('mask_on')">😷 마스크 착용</button>
  <button onclick="sendMessage('mask_off')">🙅‍♂️ 미착용</button>

  <div id="log"></div>

  <script>
    let bluetoothDevice;
    let txCharacteristic;

    function log(msg) {
      console.log(msg);
      document.getElementById("log").innerHTML += msg + "<br>";
    }

    async function connectMicrobit() {
      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] // Nordic UART Service
        });

        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        txCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");

        log("✅ micro:bit 연결 성공: " + bluetoothDevice.name);
      } catch (error) {
        log("❌ 연결 실패: " + error);
      }
    }

    async function sendMessage(message) {
      if (!txCharacteristic) {
        log("⚠️ micro:bit가 연결되지 않았습니다.");
        return;
      }
      const encoder = new TextEncoder();
      await txCharacteristic.writeValue(encoder.encode(message));
      log("📨 메시지 전송: " + message);
    }
  </script>
</body>
</html>
